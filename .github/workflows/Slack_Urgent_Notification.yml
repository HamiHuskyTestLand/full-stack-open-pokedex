on:
  pull_request:
    types: [labeled, review_requested]

jobs:
  notify_urgent:
    runs-on: ubuntu-latest

    steps:
      - name: Get PR number
        id: pr
        run: echo "number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT

      # Check 'urgent' & basic PR info (handles labeled payload race)
      - name: Check label "urgent"
        id: label_check
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = Number(`${{ steps.pr.outputs.number }}`);
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner, repo: context.repo.repo, pull_number: prNumber
            });
            const labels = (pr.labels || []).map(l => (l.name || '').trim());
            let hasUrgent = labels.some(n => n.toLowerCase() === 'urgent');

            // If this run is caused by "labeled" and the added label is urgent,
            // treat it as urgent even if pulls.get() hasn't reflected it yet.
            if (context.payload.action === 'labeled') {
              const justAdded = (context.payload.label?.name || '').toLowerCase() === 'urgent';
              if (justAdded) hasUrgent = true;
            }

            core.info(`Labels now: ${JSON.stringify(labels)} | hasUrgent=${hasUrgent}`);
            core.setOutput('hasUrgent', String(hasUrgent));
            core.setOutput('prTitle', pr.title);
            core.setOutput('prUrl', pr.html_url);

      # Decide who to notify and whether to post to channel
      - name: Compute targets & channel-post rule (dedup)
        id: targets
        uses: actions/github-script@v7
        env:
          SLACK_REVIEWER_MAP: ${{ vars.SLACK_REVIEWER_MAP }}
        with:
          script: |
            const map = JSON.parse(process.env.SLACK_REVIEWER_MAP || "{}");
            const action = context.payload.action;
            const prNumber = Number(`${{ steps.pr.outputs.number }}`);

            const listUsers = async () => {
              const { data } = await github.rest.pulls.listRequestedReviewers({
                owner: context.repo.owner, repo: context.repo.repo, pull_number: prNumber
              });
              return (data.users || []).map(u => u.login);
            };

            let ghUsers = [];
            let shouldChannelPost = false;

            if (action === 'review_requested' && context.payload.requested_reviewer) {
              // Only the newly added reviewer
              ghUsers = [context.payload.requested_reviewer.login];
              shouldChannelPost = true; // always post for review_requested
            } else if (action === 'labeled') {
              const isUrgentLabel = (context.payload.label?.name || '').toLowerCase() === 'urgent';
              if (isUrgentLabel) {
                // Post to channel for urgent label; mention current reviewers if any
                ghUsers = await listUsers();   // may be []
                shouldChannelPost = true;      // ALWAYS post on urgent label
              } else {
                shouldChannelPost = false;
              }
            }

            const uniq = [...new Set(ghUsers)];
            const slackIds = uniq.map(u => map[u] || map[u?.toLowerCase?.()]).filter(Boolean);
            const mentions = slackIds.map(id => `<@${id}>`).join(' ');

            core.info(`Reviewers for this event: ${JSON.stringify(uniq)}; shouldChannelPost=${shouldChannelPost}`);
            core.setOutput('mentions', mentions);
            core.setOutput('slackIds', JSON.stringify(slackIds));
            core.setOutput('hasReviewers', String(slackIds.length > 0));
            core.setOutput('shouldChannelPost', String(shouldChannelPost));

      # Post to team channel only when our rule says so AND PR is urgent
      - name: Post to team channel (deduped)
        if: ${{ steps.label_check.outputs.hasUrgent == 'true' && steps.targets.outputs.shouldChannelPost == 'true' }}
        uses: slackapi/slack-github-action@v1.25.0
        with:
          channel-id: ${{ secrets.SLACK_CHANNEL_ID }}
          slack-message: >
            ðŸš¨ Urgent PR: <${{ steps.label_check.outputs.prUrl }}|${{ steps.label_check.outputs.prTitle }}>
            needs review ASAP! ${{ steps.targets.outputs.hasReviewers == 'true' && steps.targets.outputs.mentions || '' }}
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}

      # DM reviewers only when we have any (review_requested or existing reviewers on label)
      - name: DM reviewers
        if: ${{ steps.label_check.outputs.hasUrgent == 'true' && steps.targets.outputs.hasReviewers == 'true' }}
        uses: actions/github-script@v7
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
        with:
          script: |
            const token = process.env.SLACK_BOT_TOKEN;
            const slackIds = JSON.parse(`${{ steps.targets.outputs.slackIds }}`);
            const prUrl = `${{ steps.label_check.outputs.prUrl }}`;
            const prTitle = `${{ steps.label_check.outputs.prTitle }}`;
            const text = `ðŸš¨ Urgent PR: <${prUrl}|${prTitle}> needs your review ASAP.`;

            for (const userId of slackIds) {
              // Open DM (requires Slack scope: im:write)
              let res = await fetch('https://slack.com/api/conversations.open', {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded','Authorization': `Bearer ${token}`},
                body: new URLSearchParams({ users: userId })
              });
              const opened = await res.json();
              if (!opened.ok) { core.warning(`Open DM failed for ${userId}: ${JSON.stringify(opened)}`); continue; }

              // Send message (requires chat:write)
              res = await fetch('https://slack.com/api/chat.postMessage', {
                method: 'POST',
                headers: {'Content-Type': 'application/json; charset=utf-8','Authorization': `Bearer ${token}`},
                body: JSON.stringify({ channel: opened.channel.id, text })
              });
              const sent = await res.json();
              if (!sent.ok) core.warning(`DM failed for ${userId}: ${JSON.stringify(sent)}`);
            }
