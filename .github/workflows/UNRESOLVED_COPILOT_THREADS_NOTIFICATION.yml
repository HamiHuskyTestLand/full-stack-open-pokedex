name: Notify PR Owner of Unresolved Copilot Reviews

on:
  pull_request_review:
    types: [submitted]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  check-approval-status:
    uses: ./.github/workflows/check-all-reviewers-approved.yml
    with:
      pr_number: ${{ github.event.pull_request.number }}

  check-copilot-threads:
    needs: check-approval-status
    runs-on: ubuntu-latest
    if: |
      github.event.review.state == 'approved' && 
      needs.check-approval-status.outputs.all_approved == 'true'
    steps:
      - name: Check for unresolved Copilot review threads
        id: check-threads
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const prNumber = context.payload.pull_request.number;
            const prOwner = context.payload.pull_request.user.login;

            const allThreads = await github.paginate.iterator(
                github.graphql.paginate,
                `query($owner: String!, $repo: String!, $number: Int!, $cursor: String) {
                    repository(owner: $owner, name: $repo) {
                        pullRequest(number: $number) {
                            reviewThreads(first: 100, after: $cursor) {
                                nodes {
                                    isResolved
                                    comments(first: 1) {
                                        nodes {
                                            author { login }
                                            body
                                            url
                                        }
                                    }
                                }
                                pageInfo {
                                    hasNextPage
                                    endCursor
                                }
                            }
                        }
                    }
                }`,
                { owner, repo, number: prNumber }
            );

            const threads = [];
            for await (const response of allThreads) {
                threads.push(...response.repository.pullRequest.reviewThreads.nodes);
            }

            const copilotLogins = ['copilot', 'github-copilot[bot]', 'github-advanced-security[bot]'];
            const unresolvedCopilotThreads = threads.filter(thread =>
                !thread.isResolved
                && thread.comments.nodes.length > 0
                && thread.comments.nodes[0]?.author?.login
                && copilotLogins.includes(thread.comments.nodes[0].author.login)
            );

            if (unresolvedCopilotThreads.length === 0) return;

            const threadList = unresolvedCopilotThreads
                .map((thread, index) => {
                    const preview = thread.comments.nodes[0].body.substring(0, 70);
                    return `${index + 1}. [View thread](${thread.comments.nodes[0].url}) - ${preview}${preview.length >= 70 ? '...' : ''}`;
                })
                .join('\n');

            core.setOutput('prOwner', prOwner);
            core.setOutput('unresolvedCount', unresolvedCopilotThreads.length);
            core.setOutput('threadList', threadList);

      - name: Comment on PR to notify owner
        if: steps.check-threads.outputs.prOwner
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            @${{ steps.check-threads.outputs.prOwner }} All reviewers have approved this PR, but there are ${{ steps.check-threads.outputs.unresolvedCount }} unresolved Copilot review thread(s). Please review and resolve these suggestions. Thank you!

            **Unresolved Copilot review threads:**
            ${{ steps.check-threads.outputs.threadList }}
