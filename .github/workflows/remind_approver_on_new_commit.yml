name: Notify Stale Reviewer

on:
  pull_request:
    types: [synchronize]

permissions:
  pull-requests: write

jobs:
  check-pusher-is-reviewer:
    runs-on: ubuntu-latest
    outputs:
      should_skip: ${{ steps.check.outputs.should_skip }}
      all_reviewers: ${{ steps.check.outputs.all_reviewers }}
    steps:
      - name: Check if pusher is reviewer
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const prNumber = context.payload.pull_request.number;
            const pusher = context.payload.sender.login;
            const prAuthor = context.payload.pull_request.user.login;

            const allTimelineEvents = await github.paginate(
                github.rest.issues.listEventsForTimeline,
                {
                    owner, 
                    repo, 
                    issue_number: prNumber, 
                    per_page: 100
                }
            );

            const allEverRequestedReviewers = new Set(
                context.payload.pull_request.requested_reviewers.map(r => r.login)
            );
            
            allTimelineEvents.forEach(e => {
                if (e.event === 'review_requested' && e.requested_reviewer) {
                    allEverRequestedReviewers.add(e.requested_reviewer.login);
                }
            });

            const isPusherReviewer = 
                allEverRequestedReviewers.has(pusher) && pusher !== prAuthor;
            
            core.setOutput('should_skip', isPusherReviewer ? 'true' : 'false');
            core.setOutput('all_reviewers', JSON.stringify([...allEverRequestedReviewers]));

  check-approval-status:
    needs: check-pusher-is-reviewer
    if: needs.check-pusher-is-reviewer.outputs.should_skip == 'false'
    uses: ./.github/workflows/CHECK_ALL_REVIEWERS_APPROVED.yml
    with:
      pr_number: ${{ github.event.pull_request.number }}

  notify-stale-reviewer:
    needs: [check-pusher-is-reviewer, check-approval-status]
    runs-on: ubuntu-latest
    if: |
      needs.check-pusher-is-reviewer.outputs.should_skip == 'false'
      && needs.check-approval-status.outputs.all_approved == 'true'
    steps:
      - name: Find most recent approver
        id: find-approver
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const prNumber = context.payload.pull_request.number;

            const allEverRequestedReviewers = new Set(
                JSON.parse('${{ needs.check-pusher-is-reviewer.outputs.all_reviewers }}')
            );

            const allReviews = await github.paginate(
                github.rest.pulls.listReviews,
                {
                    owner,
                    repo,
                    pull_number: prNumber,
                    per_page: 100
                }
            );

            const latestReviewsByUser = allReviews.reduce(
                (acc, r) => ({ ...acc, [r.user.login]: r }),
                {}
            );

            const currentApprovers = Object.values(latestReviewsByUser)
                .filter(review =>
                    review.state === 'APPROVED'
                    && review.user.type !== 'Bot'
                    && !review.user.login.endsWith('[bot]')
                    && allEverRequestedReviewers.has(review.user.login)
                )
                .sort((a, b) => new Date(b.submitted_at) - new Date(a.submitted_at));

            if (currentApprovers.length > 0) {
                core.setOutput('mostRecentApprover', currentApprovers[0].user.login);
            }

      - name: Comment on PR to notify stale reviewer
        if: steps.find-approver.outputs.mostRecentApprover
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            @${{ steps.find-approver.outputs.mostRecentApprover }} A new commit has been pushed to this PR. Please review again if your review appears stale and merging is blocked.
