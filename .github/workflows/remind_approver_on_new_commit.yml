name: Notify Stale Reviewer

on:
  pull_request:
    types: [synchronize]

permissions:
  pull-requests: write

jobs:
  notify-stale-reviewer:
    runs-on: ubuntu-latest
    steps:
      - name: Find current approvers
        id: find-approvers
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            
            const { data: reviews } = await github.rest.pulls.listReviews({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });
            
            console.log(`Total reviews: ${reviews.length}`);
            
            // Get latest review per user
            const latestReviewsByUser = reviews.reduce((acc, review) => {
              acc[review.user.login] = review;
              return acc;
            }, {});
            
            console.log('Latest reviews by user:', Object.keys(latestReviewsByUser).map(user => ({
              user,
              state: latestReviewsByUser[user].state,
              submitted_at: latestReviewsByUser[user].submitted_at
            })));
            
            // Get all human reviewers (exclude bots)
            const humanReviewers = Object.values(latestReviewsByUser)
              .filter(review => !review.user.login.endsWith('[bot]'));
            
            console.log(`Human reviewers count: ${humanReviewers.length}`);
            console.log('Human reviewers states:', humanReviewers.map(r => ({
              user: r.user.login,
              state: r.state
            })));
            
            // Check if ALL human reviewers have approved
            const allApproved = humanReviewers.length > 0 && 
                               humanReviewers.every(review => review.state === 'APPROVED');
            
            console.log(`All approved: ${allApproved}`);
            
            if (allApproved) {
              // Find most recent approver
              const mostRecentApprover = humanReviewers
                .sort((a, b) => new Date(b.submitted_at) - new Date(a.submitted_at))[0];
              
              return {
                hasApprovals: true,
                prNumber,
                mostRecentApprover: mostRecentApprover.user.login
              };
            }
            
            return { hasApprovals: false };

      - name: Comment on PR to notify stale reviewers
        if: fromJson(steps.find-approvers.outputs.result).hasApprovals
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ fromJson(steps.find-approvers.outputs.result).prNumber }}
          body: |
            @${{ fromJson(steps.find-approvers.outputs.result).mostRecentApprover }} A new commit has been pushed to this PR. Please review again if your review appears stale and merging is blocked.
