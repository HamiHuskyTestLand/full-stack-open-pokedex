name: Notify Latest Approver

on:
  pull_request:
    types: [synchronize]

permissions:
  pull-requests: write

jobs:
  notify-latest-approver:
    runs-on: ubuntu-latest
    steps:
      - name: Find current approvers
        id: find-approvers
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const prNumber = pr.number;

            const { data: reviews } = await github.rest.pulls.listReviews({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });

            // Filter out all approved reviewers, exclude bots
            const approvedReviews = reviews.filter(r => r.state === 'APPROVED' && r.user && r.user.login && !r.user.login.endsWith('[bot]'));

            if (approvedReviews.length === 0) {
              return { hasApprovals: false };
            }

            // Get the most recent approver
            approvedReviews.sort((a, b) => new Date(a.submitted_at) - new Date(b.submitted_at));
            const latest = approvedReviews[approvedReviews.length - 1];
            const reviewer = latest.user.login;

            return {
              hasApprovals: true,
              prNumber,
              mostRecentApprover: reviewer
            };
      - name: Comment on PR to notify stale reviewer
        if: fromJson(steps.find-approvers.outputs.result).hasApprovals
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ fromJson(steps.find-approvers.outputs.result).prNumber }}
          body: |
            @${{ fromJson(steps.find-approvers.outputs.result).mostRecentApprover }} A new commit has been pushed to this PR. Please review again if your review appears stale and merging is blocked.
