name: Notify Need Approval On PR Push (Only When Approved Exists)

on:
  pull_request:
    types: [synchronize]

permissions:
  issues: write
  pull-requests: write

jobs:
  notify-need-approval:
    runs-on: ubuntu-latest
    steps:
      - name: Check for approved review
        id: approved
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          REPO="${{ github.repository }} "
          REPO="$(echo $REPO | tr -d ' ')"
          APPROVED_REVIEWERS=$(gh api -H "Accept: application/vnd.github.v3+json" "/repos/$REPO/pulls/$PR_NUMBER/reviews" \
          | jq -r '
            [group_by(.user.login)[] | last | select(.state=="APPROVED")] 
            | map(.user.login) 
            | unique 
            | join(" ")
          ')
          echo "approved_reviewers=${APPROVED_REVIEWERS}" >> $GITHUB_OUTPUT

      - name: Comment on PR to notify reviewer
        if: ${{ steps.approved.outputs.approved_reviewer != '' }}
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            @${{ steps.approved.outputs.approved_reviewer }} A new commit has been pushed to this PR. Please check the merge panel to see if your review is stale, and re-approve if needed.

